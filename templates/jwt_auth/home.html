{% extends 'base.html' %}

{% block title %}JWT Authentication - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="text-center mb-4">üé´ JWT Authentication</h1>
        <p class="text-center text-muted">Stateless authentication with JSON Web Tokens</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="auth-method">
            <h3>üé´ JWT Authentication Features</h3>
            <p>This implementation demonstrates comprehensive JWT-based authentication with session management, token blacklisting, and security monitoring.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>üîë JWT Features</h5>
                    <ul>
                        <li><strong>Stateless Authentication</strong> - No server-side sessions</li>
                        <li><strong>Access & Refresh Tokens</strong> - Secure token rotation</li>
                        <li><strong>Token Blacklisting</strong> - Revoke compromised tokens</li>
                        <li><strong>Session Tracking</strong> - Monitor active sessions</li>
                        <li><strong>Device Information</strong> - Track login devices</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>üõ°Ô∏è Security Features</h5>
                    <ul>
                        <li><strong>Rate Limiting</strong> - Prevent brute force attacks</li>
                        <li><strong>Login Monitoring</strong> - Track failed attempts</li>
                        <li><strong>IP Tracking</strong> - Monitor login locations</li>
                        <li><strong>Automatic Cleanup</strong> - Remove expired tokens</li>
                        <li><strong>Custom Claims</strong> - Extended token information</li>
                    </ul>
                </div>
            </div>

            <div class="mt-4">
                {% if user.is_authenticated %}
                    <div class="alert alert-success">
                        <strong>‚úÖ You are logged in!</strong><br>
                        Welcome back, {{ user.username }}! You have {{ session_count }} active JWT session{{ session_count|pluralize }}.
                    </div>
                    
                    {% if user_sessions %}
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6>üîë Your Active JWT Sessions</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Session ID</th>
                                            <th>Device</th>
                                            <th>IP Address</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for session in user_sessions %}
                                        <tr>
                                            <td class="small">{{ session.session_id|truncatechars:12 }}...</td>
                                            <td class="small">
                                                {% if session.device_info.browser %}
                                                    {{ session.device_info.browser|truncatechars:20 }}
                                                {% else %}
                                                    Unknown
                                                {% endif %}
                                            </td>
                                            <td class="small">{{ session.ip_address }}</td>
                                            <td class="small">{{ session.created_at|date:"M d, H:i" }}</td>
                                            <td>
                                                {% if session.is_active and not session.is_expired %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Expired</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{% url 'jwt_auth:dashboard' %}" class="btn btn-primary me-2">JWT Dashboard</a>
                        <a href="{% url 'jwt_auth:session_management' %}" class="btn btn-outline-primary me-2">Manage Sessions</a>
                        <a href="{% url 'jwt_auth:profile' %}" class="btn btn-outline-secondary me-2">Profile</a>
                        <a href="{% url 'jwt_auth:logout' %}" class="btn btn-outline-danger">Logout</a>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Not authenticated</strong><br>
                        Please log in to create and manage JWT sessions.
                    </div>
                    <a href="{% url 'jwt_auth:login' %}" class="btn btn-primary me-2">Login</a>
                    <a href="{% url 'jwt_auth:register' %}" class="btn btn-outline-primary">Register</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>üìä JWT Status</h5>
            </div>
            <div class="card-body">
                <div id="jwt-status">
                    <p>Loading JWT status...</p>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="checkJWTStatus()">Refresh Status</button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>üìö JWT API Documentation</h5>
            </div>
            <div class="card-body">
                <h6>Available Endpoints:</h6>
                <ul class="small">
                    <li><code>POST /jwt/api/login/</code> - JWT login</li>
                    <li><code>POST /jwt/api/logout/</code> - JWT logout</li>
                    <li><code>GET /jwt/api/user/</code> - User profile</li>
                    <li><code>GET /jwt/api/sessions/</code> - User sessions</li>
                    <li><code>POST /jwt/api/token/refresh/</code> - Refresh token</li>
                </ul>
                
                <h6 class="mt-3">Authentication Header:</h6>
                <code class="small">Authorization: Bearer YOUR_JWT_TOKEN</code>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>üß™ Test JWT API</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="jwt-token" class="form-label">JWT Token:</label>
                    <input type="text" class="form-control form-control-sm" id="jwt-token" placeholder="Enter your JWT token">
                </div>
                <button class="btn btn-outline-success btn-sm" onclick="testJWTAPI()">Test API Call</button>
                <div id="jwt-result" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h4>üîó Other Authentication Methods</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>üîê Basic Auth</h6>
                        <a href="/basic/" class="btn btn-outline-primary btn-sm">Try Basic</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>üç™ Cookie Auth</h6>
                        <a href="/cookie/" class="btn btn-outline-secondary btn-sm">Try Cookie</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>üéüÔ∏è Token Auth</h6>
                        <a href="/token/" class="btn btn-outline-info btn-sm">Try Token</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>üîë OAuth</h6>
                        <a href="/oauth/" class="btn btn-outline-warning btn-sm">Try OAuth</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function checkJWTStatus() {
    fetch('/jwt/api/status/')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('jwt-status');
            let statusHtml = '';
            
            if (data.session_authenticated) {
                statusHtml += `
                    <div class="alert alert-success alert-sm">
                        <strong>‚úÖ Session Active</strong><br>
                        User: ${data.username} (ID: ${data.user_id})
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="alert alert-warning alert-sm">
                        <strong>‚ùå No Session</strong>
                    </div>
                `;
            }
            
            statusHtml += `
                <div class="small">
                    <strong>JWT Status:</strong><br>
                    ‚Ä¢ JWT Header: ${data.has_jwt_header ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ Token Valid: ${data.jwt_info && !data.jwt_info.error && !data.jwt_info.is_blacklisted ? '‚úÖ' : '‚ùå'}
                </div>
            `;
            
            if (data.jwt_info && !data.jwt_info.error) {
                statusHtml += `
                    <div class="small mt-2">
                        <strong>JWT Info:</strong><br>
                        ‚Ä¢ JTI: ${data.jwt_info.jti ? data.jwt_info.jti.substring(0, 8) + '...' : 'N/A'}<br>
                        ‚Ä¢ Blacklisted: ${data.jwt_info.is_blacklisted ? '‚ùå' : '‚úÖ'}
                    </div>
                `;
            }
            
            if (data.session_info) {
                statusHtml += `
                    <div class="small mt-2">
                        <strong>Session Info:</strong><br>
                        ‚Ä¢ Session ID: ${data.session_info.session_id.substring(0, 8)}...<br>
                        ‚Ä¢ Active: ${data.session_info.is_active ? '‚úÖ' : '‚ùå'}<br>
                        ‚Ä¢ IP: ${data.session_info.ip_address}
                    </div>
                `;
            }
            
            statusDiv.innerHTML = statusHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('jwt-status').innerHTML = `
                <div class="alert alert-danger alert-sm">
                    <strong>Error checking status</strong>
                </div>
            `;
        });
}

function testJWTAPI() {
    const token = document.getElementById('jwt-token').value;
    const resultDiv = document.getElementById('jwt-result');
    
    if (!token) {
        resultDiv.innerHTML = '<div class="alert alert-warning alert-sm">Please enter a JWT token</div>';
        return;
    }
    
    fetch('/jwt/api/user/', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.user_id) {
            resultDiv.innerHTML = `
                <div class="alert alert-success alert-sm">
                    <strong>‚úÖ JWT API Success</strong><br>
                    User: ${data.username}<br>
                    Sessions: ${data.active_sessions}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-sm">
                    <strong>‚ùå JWT API Error</strong><br>
                    ${data.error || 'Invalid token'}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger alert-sm">
                <strong>‚ùå Request Failed</strong><br>
                Check token and try again
            </div>
        `;
    });
}

// Check status on page load
document.addEventListener('DOMContentLoaded', checkJWTStatus);

// Auto-refresh every 30 seconds
setInterval(checkJWTStatus, 30000);
</script>
{% endblock %}
